{% load music_extras %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MusicTrace — Dashboard</title>

<style>
body {
    margin: 0;
    font-family: Inter, Arial, sans-serif;
    background: #0f0b1c;
    color: #fff;
}
a { text-decoration: none; color: inherit; }

.dashboard {
    padding: 30px;
    max-width: 1400px;
    margin: 0 auto;
}

.card {
    background: #1b1630;
    border-radius: 16px;
    padding: 24px;
}

.header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
}

.source-switch a {
    padding: 8px 14px;
    border-radius: 20px;
    background: #241f3d;
    margin-right: 10px;
    cursor: pointer;
}
.source-switch .active {
    background: linear-gradient(90deg,#a855f7,#ec4899);
}

.grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
}

.now-playing {
    display: flex;
    gap: 16px;
}
.now-playing img {
    width: 140px;
    height: 140px;
    border-radius: 12px;
}

.skeleton-cover {
    width: 140px;
    height: 140px;
    border-radius: 12px;
    background: linear-gradient(90deg,#2f2a4f 25%,#3a3560 37%,#2f2a4f 63%);
    background-size: 400% 100%;
    animation: shimmer 1.4s infinite;
}
.skeleton-line {
    height: 16px;
    width: 200px;
    background: #2f2a4f;
    border-radius: 8px;
    margin-top: 12px;
}
@keyframes shimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}

.stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 24px;
}
.stat-card {
    text-align: center;
}
.stat-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 10px solid #2f2a4f;
    margin: 16px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(circle, rgba(168,85,247,.2), transparent 70%);
}
.stat-percent {
    font-size: 28px;
    font-weight: 700;
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.activity-tabs {
    display: flex;
    background: #241f3d;
    border-radius: 20px;
    padding: 4px;
}
.activity-tabs button {
    border: none;
    background: transparent;
    color: #fff;
    padding: 6px 14px;
    border-radius: 16px;
    cursor: pointer;
    opacity: .6;
}
.activity-tabs button.active {
    background: linear-gradient(90deg,#a855f7,#ec4899);
    opacity: 1;
}

.activity-chart {
    display: flex;
    align-items: flex-end;
    height: 160px;
    gap: 8px;
    margin-top: 16px;
}
.activity-bar {
    flex: 1;
    background: #2f2a4f;
    border-radius: 6px 6px 0 0;
}
.activity-bar.active {
    background: linear-gradient(180deg,#a855f7,#ec4899);
}

.recent-track {
    display: flex;
    gap: 12px;
    margin-bottom: 14px;
}
.recent-track img {
    width: 42px;
    height: 42px;
    border-radius: 6px;
}

.ai-card {
    margin-top: 24px;
    background: linear-gradient(135deg,#6d28d9,#db2777);
}
.ai-track {
    display: flex;
    gap: 12px;
    align-items: center;
}
.ai-track img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
}
.ai-btn {
    margin-top: 16px;
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: none;
    background: rgba(255,255,255,.2);
    color: #fff;
    font-weight: 600;
}
</style>
</head>

<body>

<div class="dashboard">

    <div class="header">
        <h2>Music Analytics</h2>
        <div class="source-switch"></div>
    </div>

    <div class="grid">

        <div>

            <div class="card" id="now-playing-card">
                <div class="now-playing">
                    <div class="skeleton-cover"></div>
                    <div>
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line"></div>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="card stat-card" id="stat-genre">
                    <small>TOP GENRE</small>
                    <div class="stat-circle">
                        <span class="stat-percent">--%</span>
                    </div>
                    <strong class="stat-name">—</strong>
                </div>

                <div class="card stat-card" id="stat-artist">
                    <small>TOP ARTIST</small>
                    <div class="stat-circle">
                        <span class="stat-percent">--%</span>
                    </div>
                    <strong class="stat-name">—</strong>
                </div>
            </div>

            <div class="card" style="margin-top:24px">
                <div class="activity-header">
                    <h3>Activity Volume</h3>
                    <div class="activity-tabs">
                        <button data-period="day" class="active">Day</button>
                        <button data-period="week">Week</button>
                        <button data-period="month">Month</button>
                    </div>
                </div>
                <div class="activity-chart" id="activity-chart"></div>
            </div>

        </div>

        <div>

            <div class="card">
                <h3>Recent History</h3>
                <div id="recent-list"></div>
            </div>

            <div class="card ai-card">
                <small>AI SUGGESTION</small>
                <div class="ai-track">
                    <img src="https://via.placeholder.com/60">
                    <div>
                        <strong>Touch</strong><br>
                        <small>Daft Punk</small>
                    </div>
                </div>
                <button class="ai-btn" disabled>Listen now</button>
            </div>

        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

    const sourceSwitch = document.querySelector(".source-switch");
    const nowPlayingCard = document.getElementById("now-playing-card");

    let activeSource = null;
    let activePeriod = "day";

    const servicesResp = await fetch("/api/user/services/");
    const servicesData = await servicesResp.json();

    if (!servicesData.services.length) {
        document.body.innerHTML = "<h2 style='padding:40px'>Подключите сервис</h2>";
        return;
    }

    activeSource = servicesData.default;

    ["yandex","spotify"].forEach(service => {
        const connected = servicesData.services.includes(service);
        const btn = document.createElement("a");
        btn.textContent = service === "yandex" ? "Yandex Music" : "Spotify";
        if (service === activeSource) btn.classList.add("active");

        btn.onclick = e => {
            e.preventDefault();
            if (!connected) {
                window.location.href = `/${service}/connect/`;
                return;
            }
            activeSource = service;
            [...sourceSwitch.children].forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            loadAll();
        };

        sourceSwitch.appendChild(btn);
    });

    function loadNowPlaying() {
        nowPlayingCard.innerHTML = `
            <div class="now-playing">
                <div class="skeleton-cover"></div>
                <div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                </div>
            </div>
        `;

        fetch(`/api/now-playing/?source=${activeSource}`)
            .then(r => r.json())
            .then(d => {
                if (d.status !== "ok") {
                    nowPlayingCard.innerHTML = "<p>Nothing playing</p>";
                    return;
                }
                nowPlayingCard.innerHTML = `
                    <div class="now-playing">
                        <img src="${d.track.cover}">
                        <div>
                            <small>NOW PLAYING</small>
                            <h2>${d.track.title}</h2>
                            <p>${d.track.artist}</p>
                        </div>
                    </div>
                `;
            });
    }

    function loadStatsSummary() {
        fetch(`/api/stats/summary/?source=${activeSource}`)
            .then(r => r.json())
            .then(d => {
                document.querySelector("#stat-genre .stat-percent").innerText = d.top_genre.percent + "%";
                document.querySelector("#stat-genre .stat-name").innerText = d.top_genre.name;
                document.querySelector("#stat-artist .stat-percent").innerText = d.top_artist.percent + "%";
                document.querySelector("#stat-artist .stat-name").innerText = d.top_artist.name;
            });
    }

    function loadRecent() {
        fetch(`/api/stats/recent/?source=${activeSource}`)
            .then(r => r.json())
            .then(d => {
                const list = document.getElementById("recent-list");
                list.innerHTML = "";
                d.tracks.slice(0,10).forEach(t => {
                    list.innerHTML += `
                        <div class="recent-track">
                            <img src="${t.cover}">
                            <div>
                                <strong>${t.title}</strong><br>
                                <small>${t.artist}</small>
                            </div>
                        </div>
                    `;
                });
            });
    }

    function loadActivity() {
        fetch(`/api/stats/activity/?period=${activePeriod}&source=${activeSource}`)
            .then(r => r.json())
            .then(d => {
                const chart = document.getElementById("activity-chart");
                chart.innerHTML = "";
                const max = Math.max(...d.data, 1);
                d.data.forEach(v => {
                    const bar = document.createElement("div");
                    bar.className = "activity-bar";
                    bar.style.height = v === 0 ? "4px" : `${(v/max)*100}%`;
                    if (v === max) bar.classList.add("active");
                    chart.appendChild(bar);
                });
            });
    }

    document.querySelectorAll(".activity-tabs button").forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll(".activity-tabs button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            activePeriod = btn.dataset.period;
            loadActivity();
        };
    });

    function loadAll() {
        loadNowPlaying();
        loadStatsSummary();
        loadRecent();
        loadActivity();
    }

    loadAll();
});
</script>

</body>
</html>