{% load music_extras %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MusicTrace — Dashboard</title>

<style>
body {
    margin: 0;
    font-family: Inter, Arial, sans-serif;
    background: #0f0b1c;
    color: #fff;
}
a { text-decoration: none; color: inherit; }

.dashboard {
    padding: 30px;
    max-width: 1400px;
    margin: 0 auto;
}

.card {
    background: #1b1630;
    border-radius: 16px;
    padding: 24px;
}

.header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
}

.source-switch a {
    padding: 8px 14px;
    border-radius: 20px;
    background: #241f3d;
    margin-right: 10px;
    cursor: pointer;
}
.source-switch .active {
    background: linear-gradient(90deg,#a855f7,#ec4899);
}

.grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 24px;
}

.now-playing {
    display: flex;
    gap: 16px;
}
.now-playing img {
    width: 140px;
    height: 140px;
    border-radius: 12px;
}

.skeleton-cover {
    width: 140px;
    height: 140px;
    border-radius: 12px;
    background: linear-gradient(90deg,#2f2a4f 25%,#3a3560 37%,#2f2a4f 63%);
    background-size: 400% 100%;
    animation: shimmer 1.4s infinite;
}
.skeleton-line {
    height: 16px;
    width: 200px;
    background: #2f2a4f;
    border-radius: 8px;
    margin-top: 12px;
}
@keyframes shimmer {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}

.stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 24px;
}
.stat-card {
    text-align: center;
}
.stat-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 10px solid #2f2a4f;
    margin: 16px auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(circle, rgba(168,85,247,.2), transparent 70%);
}
.stat-percent {
    font-size: 28px;
    font-weight: 700;
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.activity-tabs {
    display: flex;
    background: #241f3d;
    border-radius: 20px;
    padding: 4px;
}
.activity-tabs button {
    border: none;
    background: transparent;
    color: #fff;
    padding: 6px 14px;
    border-radius: 16px;
    cursor: pointer;
    opacity: .6;
}
.activity-tabs button.active {
    background: linear-gradient(90deg,#a855f7,#ec4899);
    opacity: 1;
}

.activity-chart {
    display: flex;
    align-items: flex-end;
    height: 160px;
    gap: 8px;
    margin-top: 16px;
}
.activity-bar {
    flex: 1;
    background: #2f2a4f;
    border-radius: 6px 6px 0 0;
}
.activity-bar.active {
    background: linear-gradient(180deg,#a855f7,#ec4899);
}

.recent-track {
    display: flex;
    gap: 12px;
    margin-bottom: 14px;
}
.recent-track img {
    width: 42px;
    height: 42px;
    border-radius: 6px;
}

.ai-card {
    margin-top: 24px;
    background: linear-gradient(135deg,#6d28d9,#db2777);
}
.ai-track {
    display: flex;
    gap: 12px;
    align-items: center;
}
.ai-track img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
}
.ai-btn {
    margin-top: 16px;
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: none;
    background: rgba(255,255,255,.2);
    color: #fff;
    font-weight: 600;
}
</style>
</head>

<body>

<div class="dashboard">

    <div class="header">
        <h2>Music Analytics</h2>
        <div class="source-switch"></div>
    </div>

    <div class="grid">

        <div>

            <div class="card" id="now-playing-card">
                <div class="now-playing">
                    <div class="skeleton-cover"></div>
                    <div>
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line"></div>
                    </div>
                </div>
            </div>

            <div class="stats">
                <div class="card stat-card" id="stat-genre">
                    <small>TOP GENRE</small>
                    <div class="stat-circle">
                        <span class="stat-percent">--%</span>
                    </div>
                    <strong class="stat-name">—</strong>
                </div>

                <div class="card stat-card" id="stat-artist">
                    <small>TOP ARTIST</small>
                    <div class="stat-circle">
                        <span class="stat-percent">--%</span>
                    </div>
                    <strong class="stat-name">—</strong>
                </div>
            </div>

            <div class="card" style="margin-top:24px">
                <div class="activity-header">
                    <h3>Activity Volume</h3>
                    <div class="activity-tabs">
                        <button data-period="day" class="active">Day</button>
                        <button data-period="week">Week</button>
                        <button data-period="month">Month</button>
                    </div>
                </div>
                <div class="activity-chart" id="activity-chart"></div>
            </div>

        </div>

        <div>

            <div class="card">
                <h3>Recent History</h3>
                <div id="recent-list"></div>
            </div>

            <div class="card ai-card">
                <small>AI SUGGESTION</small>
                <div class="ai-track">
                    <img src="https://via.placeholder.com/60">
                    <div>
                        <strong>Touch</strong><br>
                        <small>Daft Punk</small>
                    </div>
                </div>
                <button class="ai-btn" disabled>Listen now</button>
            </div>

        </div>

    </div>
</div>

<script>
const state = {
    activeSource: null,
    activePeriod: "day",
    nowPlayingRequestId: 0,
};

const els = {
    sourceSwitch: document.querySelector(".source-switch"),
    nowPlayingCard: document.getElementById("now-playing-card"),
    recentList: document.getElementById("recent-list"),
    activityChart: document.getElementById("activity-chart"),
    activityTabs: document.querySelectorAll(".activity-tabs button"),
};

async function fetchJSON(url) {
    const res = await fetch(url);
    return res.json();
}

function renderSkeleton() {
    els.nowPlayingCard.innerHTML = `
        <div class="now-playing">
            <div class="skeleton-cover"></div>
            <div>
                <div class="skeleton-line"></div>
                <div class="skeleton-line"></div>
            </div>
        </div>
    `;
}

document.addEventListener("DOMContentLoaded", init);

async function init() {
    const services = await fetchJSON("/api/user/services/");

    if (!services.services.length) {
        document.body.innerHTML = "<h2 style='padding:40px'>Подключите сервис</h2>";
        return;
    }

    state.activeSource = services.default;
    initSourceSwitch(services);
    initActivityTabs();
    loadAll();
}

function initSourceSwitch({ services, default: def }) {
    ["yandex", "spotify"].forEach(service => {
        const connected = services.includes(service);
        const btn = document.createElement("a");

        btn.textContent = service === "yandex" ? "Yandex Music" : "Spotify";
        if (service === def) btn.classList.add("active");

        btn.onclick = e => {
            e.preventDefault();

            if (!connected) {
                window.location.href = `/${service}/connect/`;
                return;
            }

            if (state.activeSource === service) return;

            state.activeSource = service;
            [...els.sourceSwitch.children].forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            loadAll();
        };

        els.sourceSwitch.appendChild(btn);
    });
}

async function loadNowPlaying() {
    const requestId = ++state.nowPlayingRequestId;
    renderSkeleton();

    try {
        const data = await fetchJSON(`/api/now-playing/?source=${state.activeSource}`);

        if (requestId !== state.nowPlayingRequestId) return;
        if (data.source !== state.activeSource) return;
        if (data.status === "loading") return;

        if (data.status !== "ok") {
            els.nowPlayingCard.innerHTML = "<p>Nothing playing</p>";
            return;
        }

        els.nowPlayingCard.innerHTML = `
            <div class="now-playing">
                <img src="${data.track.cover}">
                <div>
                    <small>NOW PLAYING</small>
                    <h2>${data.track.title}</h2>
                    <p>${data.track.artist}</p>
                </div>
            </div>
        `;
    } catch {
        if (requestId === state.nowPlayingRequestId) {
            els.nowPlayingCard.innerHTML = "<p>Error loading track</p>";
        }
    }
}

async function loadStatsSummary() {
    const d = await fetchJSON(`/api/stats/summary/?source=${state.activeSource}`);

    document.querySelector("#stat-genre .stat-percent").textContent = `${d.top_genre.percent}%`;
    document.querySelector("#stat-genre .stat-name").textContent = d.top_genre.name;

    document.querySelector("#stat-artist .stat-percent").textContent = `${d.top_artist.percent}%`;
    document.querySelector("#stat-artist .stat-name").textContent = d.top_artist.name;
}

async function loadRecent() {
    const d = await fetchJSON(`/api/stats/recent/?source=${state.activeSource}`);
    els.recentList.innerHTML = "";

    d.tracks.slice(0, 10).forEach(t => {
        els.recentList.insertAdjacentHTML("beforeend", `
            <div class="recent-track">
                <img src="${t.cover}">
                <div>
                    <strong>${t.title}</strong><br>
                    <small>${t.artist}</small>
                </div>
            </div>
        `);
    });
}

async function loadActivity() {
    const d = await fetchJSON(
        `/api/stats/activity/?period=${state.activePeriod}&source=${state.activeSource}`
    );

    els.activityChart.innerHTML = "";
    const max = Math.max(...d.data, 1);

    d.data.forEach(v => {
        const bar = document.createElement("div");
        bar.className = "activity-bar";
        bar.style.height = v === 0 ? "4px" : `${(v / max) * 100}%`;
        if (v === max) bar.classList.add("active");
        els.activityChart.appendChild(bar);
    });
}

function initActivityTabs() {
    els.activityTabs.forEach(btn => {
        btn.onclick = () => {
            els.activityTabs.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            state.activePeriod = btn.dataset.period;
            loadActivity();
        };
    });
}

function loadAll() {
    loadNowPlaying();
    loadStatsSummary();
    loadRecent();
    loadActivity();
}
</script>


</body>
</html>